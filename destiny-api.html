<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-request.html">

<!--
`<destiny-api>`
Polymer element to access destiny API [endpoints](http://destinydevs.github.io/BungieNetPlatform/docs/Endpoints).



@demo demo/index.html
-->

<dom-module id="destiny-api">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-request id="id"></iron-request>
    <iron-request id="stats"></iron-request>
    <iron-request id="characters"></iron-request>
    <iron-request id="trials0"></iron-request>
    <iron-request id="trials1"></iron-request>
    <iron-request id="trials2"></iron-request>
    <iron-request id="activity1"></iron-request>

  </template>

  <script>
    Polymer({

      is: 'destiny-api',
      properties: {
        apiKey: {
          type: String,
        },
        userName: {
          type: String,
          notify: true,
        },
        console: {
          type: Number,
          value: 2,
        },
        response: {
          type: Number,
          notify: true,
          value: {},
        },
        stats: {
          type: Object,
          notify: true,
          value: {},
        },
        membershipId: {
          type: String,
        },
        characters: {
          type: Array,
          notify: true,
          value: [],
        },
        loadingCharacters: {
          type: Boolean,
          notify: true,
          value: false,
        },
        loadingStats: {
          type: Boolean,
          notify: true,
          value: false,
        },
      },

      generateRequest: function(){
        this._getMembershipIdByDisplayName(this.apiKey);
      },

      _getMembershipIdByDisplayName: function(key) {
        var url = "https://www.bungie.net/platform/Destiny" + "/" + this.console +"/Stats/GetMembershipIdByDisplayName/"+ this.userName +"/";
        this.$.id.send({ url: url, headers: { "X-API-Key": key}, handleAs: "json" })
        .then(function(response){
          this.membershipId = this.$.id.parseResponse().Response;
          this._getStats(this.membershipId);
          this._getCharacters(this.membershipId);
        }.bind(this));
      },

      _getStats: function(id) {
        var url = "https://www.bungie.net/platform/Destiny/Stats/Account/"+ this.console + "/" + id +"/";
        this.$.stats.send({ url: url, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          var stats = {
            pvp: this.$.stats.parseResponse().Response.mergedAllCharacters.results.allPvP.allTime,
            pve: this.$.stats.parseResponse().Response.mergedAllCharacters.results.allPvE.allTime
          }
          this.set("response.stats", stats);
          console.log(this.response);
        }.bind(this));
      },

      _getCharacters: function(id) {
        var url = "https://www.bungie.net/platform/Destiny/" + this.console + "/Account/" + this.membershipId +"/";
        this.$.characters.send({ url: url, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          var response = this.$.characters.parseResponse().Response;
          this.set("response.characters", this._parseCharacters(response));
          this._getCharacterTrialsStats();
          this._getCharacterActivities();
          console.log(this.response);
        }.bind(this));
      },
      _parseCharacters: function(response){
        var characters = [];
        for (var i = 0; i < response.data.characters.length; i++) {
         var char = response.data.characters[i];
         characters.push({
           characterType: this._characterName(char.characterBase.classType),
           characterLevel: char.characterLevel,
           minutesPlayedTotal: char.characterBase.minutesPlayedTotal,
           lightLevel: char.characterBase.powerLevel,
           characterId: char.characterBase.characterId,
           emblemPath: char.emblemPath,
           backgroundPath: char.backgroundPath,
           stats: {
             agility: char.characterBase.stats.STAT_AGILITY.value,
             armor: char.characterBase.stats.STAT_ARMOR.value,
             defense: char.characterBase.stats.STAT_DEFENSE.value,
             dicipline: char.characterBase.stats.STAT_DISCIPLINE.value,
             intellect: char.characterBase.stats.STAT_INTELLECT.value,
             strength: char.characterBase.stats.STAT_STRENGTH.value
           },
         });
        }
        return characters;
      },


      _getCharacterTrialsStats: function(){
        // Dragon face emoji? ðŸ²
        var url0 = "https://www.bungie.net/platform/Destiny/Stats/"+ this.console + "/" + this.membershipId +"/" + this.response.characters[0].characterId + "/?modes=TrialsOfOsiris";
        var request0 = this.$.trials0;
        request0.send({ url: url0, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          this.set("response.characters.0.stats.trials", request0.parseResponse().Response.trialsOfOsiris.allTime);
        }.bind(this));

        var url1 = "https://www.bungie.net/platform/Destiny/Stats/"+ this.console + "/" + this.membershipId +"/" + this.response.characters[1].characterId + "/?modes=TrialsOfOsiris";
        var request1 = this.$.trials1;
        request1.send({ url: url1, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          this.set("response.characters.1.stats.trials", request1.parseResponse().Response.trialsOfOsiris.allTime);
        }.bind(this));

        var url2 = "https://www.bungie.net/platform/Destiny/Stats/"+ this.console + "/" + this.membershipId +"/" + this.response.characters[2].characterId + "/?modes=TrialsOfOsiris";
        var request2 = this.$.trials2;
        request2.send({ url: url2, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          this.set("response.characters.2.stats.trials", request2.parseResponse().Response.trialsOfOsiris.allTime);
        }.bind(this));
      },

      _getCharacterActivities: function(){
        var url = "https://www.bungie.net/platform/Destiny/Stats/ActivityHistory/"+ this.console + "/" + this.membershipId +"/" + this.response.characters[0].characterId + "/?mode=TrialsOfOsiris";
        var request = this.$.activity1;
        request.send({ url: url, headers: { "X-API-Key": this.apiKey}, handleAs: "json" })
        .then(function(){
          this.set("response.characters.0.activity", {trials: request.parseResponse().Response.data.activities});
          console.log(this.response);
        }.bind(this));
      },

      _characterName: function(num){
        if(num == 0){
          return "Titan";
        }else if(num == 1) {
          return "Hunter";
        }else if(num == 2) {
          return "Warlock";
        }
      }
    });
  </script>
</dom-module>
